# Rocket mq 性能测试
### 同步复制和异步复制
** 同步复制 **
1. CommitLog.putMessage 将消息写入内存缓存之中
2. 调用 handleDiskFlush进行同步/异步刷盘
3. handleHA 进行主从复制处理

** 异步复制 **
1. CommitLog.putMessage 将消息写入内存缓存之中
2. 调用 handleDiskFlush进行同步/异步刷盘
3. handleHA不会进行任何操作，也不管slave broker的复制进度，复制完全是由后台HAConnection.WriteSocketService服务在监听到有从Broker的链接可写时，向其写等待复制的数据。每个从broker发送进度则是由从broker定时汇报的自身当前已复制进度控制。该汇报由HAConnection.ReadSocketService负责处理

* 个人觉得 异步复制 + 同步刷盘 比较好一点。同步刷盘已经保证了可靠性


### 性能测试
性能测试使用了云服务器，其配置为：
* CPU：4 vCPU，双核，2.8GHz
* RAM：16GB
* OS：Ubuntu 18.04

**异步复制 异步刷盘**
|集群模式|并发数|消息大小|TPS|AverageRT|
|----|-----|-----|-----|-----|
|异步复制 异步刷盘|1|2048|2781|0.36s|
|异步复制 异步刷盘|8|2048|4800|1.47s|
|异步复制 异步刷盘|16|2048|5527|2.88s|
|异步复制 异步刷盘|32|2048|6000|5.1s|


**异步复制 同步刷盘**
|集群模式|并发数|消息大小|TPS|AverageRT|
|----|-----|-----|-----|-----|
|异步复制 同步刷盘|1|2048|387|2.58s|
|异步复制 同步刷盘|8|2048|414|19.37s|
|异步复制 同步刷盘|16|2048|||
|异步复制 同步刷盘|32|2048|||


**同步复制 异步刷盘**
|集群模式|并发数|消息大小|TPS|AverageRT|
|----|-----|-----|-----|-----|
|同步复制 异步刷盘|1|2048|||
|同步复制 异步刷盘|8|2048|||
|同步复制 异步刷盘|16|2048|||
|同步复制 异步刷盘|32|2048|||


**同步复制 同步刷盘**
|集群模式|并发数|消息大小|TPS|AverageRT|
|----|-----|-----|-----|-----|
|同步复制 同步刷盘|1|2048|352|2.5s|
|同步复制 同步刷盘|8|2048|401|18.55s|
|同步复制 同步刷盘|16|2048|403|37.4s|
|同步复制 同步刷盘|32|2048|410|75.4s|


* 当刷盘模式改为同步刷盘时候，TPS减少到了400左右。此时的磁盘利用率为100%，然而CPU利用率只有6% ~ 10%。并发数的增加也对TPS毫无增益。由此可见，在涉及同步刷盘的集群模式中，其TPS的瓶颈在于磁盘的写入速度
* 当主从的复制模式从异步复制改为同步复制时，TPS几乎不受影响
* 